<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>nQuiz | Advanced Nursing Learning</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed; background-size: cover; min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-dark { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-input { width: 100%; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; transition: all 0.2s; }
        .admin-input:focus { outline: none; border-color: #3b82f6; ring: 2px; }
        
        .icon-radio { border-radius: 50%; } 
        .icon-check { border-radius: 6px; } 
    </style>
</head>
<body class="text-gray-800 antialiased pb-20 selection:bg-brand-500 selection:text-white">

    <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <nav class="fixed top-4 left-1/2 -translate-x-1/2 w-[95%] max-w-4xl glass rounded-full shadow-lg z-50 px-5 py-3 flex items-center justify-between transition-all">
        <div class="flex items-center gap-2 cursor-pointer group" onclick="goHome()">
            <div class="bg-brand-600 text-white p-1.5 rounded-lg group-hover:rotate-12 transition-transform"><i class="ph-bold ph-first-aid text-xl"></i></div>
            <span class="font-extrabold text-xl tracking-tight text-gray-900">n<span class="text-brand-600">Quiz</span></span>
        </div>
        
        <div id="nav-user" class="hidden flex items-center gap-3">
            <button id="nav-admin-btn" onclick="openAdminPanel()" class="hidden bg-gray-900 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-black transition-colors flex items-center gap-1">
                <i class="ph-bold ph-gear"></i> ADMIN
            </button>
            <span id="display-user" class="text-xs font-bold text-gray-600 uppercase tracking-wider hidden sm:block"></span>
            <button onclick="signOut()" class="text-gray-400 hover:text-red-500 p-1"><i class="ph-bold ph-sign-out text-xl"></i></button>
        </div>
    </nav>

    <div class="container max-w-lg mx-auto px-4 pt-32 relative z-10">

        <div id="auth-screen" class="glass rounded-3xl shadow-2xl p-8 animate-slide-up">
            <h1 id="auth-title" class="text-3xl font-extrabold text-gray-900 mb-2 text-center">nQuiz Login</h1>
            <p class="text-gray-500 text-sm text-center mb-8">Master your nursing content.</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="admin-input" autocomplete="off">
                <input type="password" id="password" placeholder="Password" class="admin-input">
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">Log In</button>
            </div>
            <div class="mt-6 text-center">
                <button onclick="toggleAuthMode()" id="toggle-link" class="text-sm font-semibold text-gray-500 hover:text-brand-600">Create Account</button>
            </div>
        </div>

        <div id="dashboard-screen" class="hidden animate-slide-up">
            <div class="glass p-1.5 rounded-2xl flex mb-8 shadow-lg">
                <button onclick="setMode('study')" id="tab-study" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white text-brand-600 shadow-md">STUDY</button>
                <button onclick="setMode('test')" id="tab-test" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500">TEST</button>
            </div>
            <div id="categories-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="submenu-screen" class="hidden animate-slide-up">
            <div class="flex items-center justify-between mb-6 text-white">
                <button onclick="goHome()" class="w-10 h-10 rounded-full glass-dark flex items-center justify-center hover:bg-white hover:text-gray-900 transition-colors"><i class="ph-bold ph-arrow-left"></i></button>
                <h2 id="submenu-title" class="text-xl font-bold">Topics</h2>
                <div class="w-10"></div>
            </div>
            <div id="topics-grid" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="session-screen" class="hidden">
            <div class="glass rounded-3xl shadow-xl overflow-hidden animate-slide-up min-h-[500px] flex flex-col">
                <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-b border-gray-100">
                    <button onclick="goSubmenu()" class="text-gray-400 text-sm font-bold flex items-center gap-1 hover:text-gray-600">QUIT</button>
                    <span id="session-progress" class="text-xs font-bold text-gray-500">1/10</span>
                </div>
                <div class="p-6 md:p-8 flex-1 flex flex-col">
                    <h2 id="q-text" class="text-xl font-bold text-gray-800 leading-snug mb-8"></h2>
                    <div id="options-area" class="space-y-3 mb-6"></div>
                    <div id="rationale-area" class="hidden rounded-xl bg-blue-50 border border-blue-100 p-5 mb-4 relative">
                         <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-l-xl"></div>
                         <h4 class="text-xs font-bold text-blue-500 uppercase mb-1">Rationale</h4>
                         <p id="rationale-text" class="text-blue-900 text-sm leading-relaxed"></p>
                    </div>
                    <button id="action-btn" class="hidden w-full bg-gray-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-[0.99]">Continue</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden text-center animate-slide-up pt-10">
            <div class="glass rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-32 bg-brand-500/20 blur-3xl rounded-full pointer-events-none"></div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Session Complete!</h2>
                <div class="text-6xl font-extrabold text-brand-600 my-8 tracking-tighter" id="score-val">0%</div>
                <button onclick="goSubmenu()" class="w-full bg-white border border-gray-200 hover:border-brand-500 text-gray-700 hover:text-brand-600 font-bold py-3.5 rounded-xl transition-all">Back to Topics</button>
            </div>
        </div>

        <div id="admin-screen" class="hidden animate-slide-up">
            <div class="flex items-center justify-between mb-6 text-white">
                <button onclick="goHome()" class="w-10 h-10 rounded-full glass-dark flex items-center justify-center"><i class="ph-bold ph-arrow-left"></i></button>
                <h2 class="text-xl font-bold">Admin Dashboard</h2>
                <div class="w-10"></div>
            </div>

            <div class="glass p-1.5 rounded-xl flex mb-6">
                <button onclick="setAdminTab('add')" id="admin-tab-add" class="flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow">Add / Edit</button>
                <button onclick="setAdminTab('bulk')" id="admin-tab-bulk" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500">Bulk JSON</button>
            </div>

            <div id="admin-view-add" class="glass p-6 rounded-3xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg">Question Editor</h3>
                    <button onclick="addOption()" class="text-xs bg-brand-50 text-brand-600 px-3 py-1.5 rounded-lg font-bold hover:bg-brand-100 transition-colors">
                        + Add Option
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="adm-cat" class="admin-input" placeholder="Category (e.g. Pharma)">
                        <input id="adm-sub" class="admin-input" placeholder="Subject (e.g. Week 1)">
                    </div>
                    
                    <textarea id="adm-q" class="admin-input h-24" placeholder="Question Text"></textarea>
                    
                    <div class="bg-white/50 rounded-xl border border-gray-200 p-4">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-3 block flex justify-between">
                            <span>Options</span>
                            <span>Correct?</span>
                        </label>
                        <div id="dynamic-options-container" class="space-y-3"></div>
                    </div>

                    <textarea id="adm-rat" class="admin-input h-20" placeholder="Rationale (Explanation)"></textarea>
                    
                    <div class="flex gap-2 pt-2">
                        <button onclick="submitSingleQuestion()" id="adm-submit-btn" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-xl shadow hover:bg-green-700 transition-colors">Save Question</button>
                        <button onclick="resetAdminForm()" class="px-4 text-gray-400 hover:text-red-500 transition-colors"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
            </div>

            <div id="admin-view-bulk" class="glass p-6 rounded-3xl hidden">
                <h3 class="font-bold text-lg mb-2">Bulk Upload</h3>
                <p class="text-xs text-gray-500 mb-4">Paste JSON array.</p>
                <textarea id="adm-bulk-text" class="admin-input h-64 font-mono text-xs" placeholder='[{"category":"...","question":"...","options":["A","B"],"answer":"A","rationale":"..."}]'></textarea>
                <button onclick="submitBulk()" class="w-full mt-4 bg-brand-600 text-white font-bold py-3 rounded-xl shadow">Upload JSON</button>
            </div>

            <div class="mt-8">
                <h3 class="text-white font-bold mb-4">Manage Questions</h3>
                <div id="admin-list" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <div id="loading-screen" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center bg-gray-900/90 backdrop-blur-sm">
        <div class="loader"></div>
        <div class="text-white mt-4 font-bold tracking-wide">Processing...</div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://ilsmjyvpduvmkxoxcqin.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_7ZI3V6f0ckuxpASg3febTw_E_oxey_I";
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let appState = { 
            data: [], user: null, isAdmin: false,
            currentSet: [], index: 0, score: 0, mode: 'study', isSignUp: false,
            editingId: null 
        };

        // --- ICONS ---
        const ICONS = {
            "Pharmacology": "ph-pill", "Anatomy": "ph-bone", "Pediatrics": "ph-baby", 
            "Physiology": "ph-heartbeat", "Nutrition": "ph-apple", "General": "ph-books",
            "Cardiology": "ph-heart", "Psychiatric": "ph-brain", "Default": "ph-folder"
        };

        // --- UTILS ---
        function showToast(msg, type='success') {
            const el = document.createElement('div');
            el.className = `${type==='error'?'bg-red-500':'bg-green-500'} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-2 text-sm font-bold pointer-events-auto animate-slide-up border border-white/20`;
            el.innerHTML = `<i class="ph-bold ${type==='error'?'ph-warning-circle':'ph-check-circle'} text-lg"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function showLoading(show) { document.getElementById('loading-screen').classList.toggle('hidden', !show); }

        // --- AUTH ---
        window.onload = () => {
            const u = localStorage.getItem('quizUser');
            if(u) handleAuth(u, localStorage.getItem('quizPass'), true);
        };

        async function handleAuth(uInput, pInput, isAuto = false) {
            const u = uInput || document.getElementById('username').value.trim();
            const p = pInput || document.getElementById('password').value.trim();
            if(!u || !p) return showToast("Enter credentials", "error");

            if(!isAuto) showLoading(true);

            try {
                if(appState.isSignUp && !isAuto) {
                    const { data } = await _supabase.from('users').select('*').eq('username', u);
                    if(data.length) throw new Error("Username taken");
                    const { error } = await _supabase.from('users').insert({ username: u, password: p, is_admin: false });
                    if(error) throw error;
                    showToast("Account created!");
                } 
                
                const { data, error } = await _supabase.from('users').select('*').eq('username', u).eq('password', p);
                if(error || !data.length) throw new Error("Invalid login");

                appState.user = u;
                appState.isAdmin = data[0].is_admin;
                
                localStorage.setItem('quizUser', u);
                localStorage.setItem('quizPass', p);

                if(appState.isAdmin) {
                    document.getElementById('nav-admin-btn').classList.remove('hidden');
                    showToast(`Welcome Admin ${u}`);
                }

                loadData();
            } catch (e) {
                showToast(e.message, "error");
                showLoading(false);
            }
        }

        function toggleAuthMode() {
            appState.isSignUp = !appState.isSignUp;
            document.getElementById('auth-title').innerText = appState.isSignUp ? "Create Account" : "nQuiz Login";
            document.getElementById('auth-btn').innerText = appState.isSignUp ? "Sign Up" : "Log In";
            document.getElementById('toggle-link').innerText = appState.isSignUp ? "Back to Login" : "Create Account";
        }

        function signOut() { localStorage.clear(); location.reload(); }

        // --- DATA ---
        async function loadData() {
            try {
                const { data } = await _supabase.from('questions').select('*');
                appState.data = data || [];
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('nav-user').classList.remove('hidden');
                document.getElementById('display-user').innerText = appState.user;
                showLoading(false);
                goHome();
            } catch(e) { showToast("Error loading data", "error"); showLoading(false); }
        }

        // --- NAVIGATION ---
        function hideAll() {
            ['dashboard-screen','submenu-screen','session-screen','result-screen','admin-screen'].forEach(id => 
                document.getElementById(id).classList.add('hidden'));
        }

        function goHome() {
            hideAll();
            document.getElementById('dashboard-screen').classList.remove('hidden');
            renderDashboard();
        }

        function renderDashboard() {
            const cats = [...new Set(appState.data.map(q => q.category || 'General'))].sort();
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = "";

            // --- NEW: RANDOM QUIZ BUTTON ---
            grid.innerHTML += `
            <div onclick="startRandomSession()" class="glass p-5 rounded-2xl cursor-pointer hover:bg-white transition-all group animate-slide-up col-span-2 border-2 border-dashed border-purple-300 bg-purple-50/50">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 text-white flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform group-hover:rotate-12">
                        <i class="ph-bold ph-lightning"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-purple-900">Quick Mix</h3>
                        <p class="text-xs text-purple-600 font-semibold">5 Random Questions</p>
                    </div>
                    <div class="ml-auto bg-white p-2 rounded-full text-purple-500 shadow-sm"><i class="ph-bold ph-caret-right"></i></div>
                </div>
            </div>`;

            cats.forEach((cat, idx) => {
                const count = appState.data.filter(q => (q.category||'General') === cat).length;
                const icon = ICONS[cat] || ICONS['Default'];
                grid.innerHTML += `
                <div onclick="openCategory('${cat}')" class="glass p-5 rounded-2xl cursor-pointer hover:bg-white transition-all group animate-slide-up" style="animation-delay: ${idx*50}ms">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 text-white flex items-center justify-center mb-3 text-2xl shadow-lg group-hover:scale-110 transition-transform"><i class="ph-duotone ${icon}"></i></div>
                    <h3 class="font-bold text-lg">${cat}</h3>
                    <p class="text-xs text-gray-500 mt-1">${count} Questions</p>
                </div>`;
            });
        }

        function openCategory(cat) {
            hideAll();
            document.getElementById('submenu-screen').classList.remove('hidden');
            document.getElementById('submenu-title').innerText = cat;
            const subs = [...new Set(appState.data.filter(q=>(q.category||'General')===cat).map(q=>q.subject))].sort();
            const grid = document.getElementById('topics-grid');
            grid.innerHTML = "";
            subs.forEach((sub, idx) => {
                grid.innerHTML += `<div onclick="startSession('${sub}')" class="glass p-4 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white hover:shadow-md transition-all animate-slide-up" style="animation-delay:${idx*50}ms"><span class="font-bold text-gray-700">${sub}</span><i class="ph-bold ph-caret-right text-gray-400"></i></div>`;
            });
        }

        function goSubmenu() { if(appState.currentCategory) openCategory(appState.currentCategory); else goHome(); }
        
        function setMode(m) { 
            appState.mode = m; 
            document.getElementById('tab-study').className = m==='study' ? "flex-1 py-3 rounded-xl text-sm font-bold bg-white text-brand-600 shadow-md transform scale-100" : "flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 hover:text-gray-700";
            document.getElementById('tab-test').className = m==='test' ? "flex-1 py-3 rounded-xl text-sm font-bold bg-white text-brand-600 shadow-md transform scale-100" : "flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 hover:text-gray-700";
        }

        // --- QUIZ LOGIC ---
        function startSession(sub) {
            appState.currentSet = appState.data.filter(q => q.subject === sub).sort(()=>0.5-Math.random()).slice(0,15);
            appState.index = 0; appState.score = 0;
            hideAll();
            document.getElementById('session-screen').classList.remove('hidden');
            loadCard();
        }

        function startRandomSession() {
            if(appState.data.length === 0) return showToast("No questions available", "error");
            
            // 1. Shuffle ALL data
            const shuffled = [...appState.data].sort(() => 0.5 - Math.random());
            
            // 2. Take first 5
            appState.currentSet = shuffled.slice(0, 5);
            
            // 3. Start
            appState.index = 0; 
            appState.score = 0;
            hideAll();
            document.getElementById('session-screen').classList.remove('hidden');
            loadCard();
        }

        function loadCard() {
            const q = appState.currentSet[appState.index];
            const isStudy = appState.mode === 'study';
            
            document.getElementById('q-text').innerText = q.question;
            document.getElementById('session-progress').innerText = `${appState.index+1}/${appState.currentSet.length}`;
            document.getElementById('rationale-area').classList.add('hidden');
            
            const actionBtn = document.getElementById('action-btn');
            actionBtn.classList.add('hidden');
            
            q.userSelected = q.type === 'multi' ? [] : null; 

            const box = document.getElementById('options-area');
            box.innerHTML = "";
            
            if(q.type === 'multi') {
                const hint = document.createElement('div');
                hint.className = "text-xs font-bold text-brand-600 uppercase mb-2 tracking-wider flex items-center gap-1 animate-slide-up";
                hint.innerHTML = "<i class='ph-bold ph-check-square'></i> Select All That Apply";
                box.appendChild(hint);
            }

            let opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
            
            opts.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl bg-white border border-gray-100 hover:border-brand-500 transition-all shadow-sm mb-2 group animate-slide-up";
                btn.style.animationDelay = `${idx * 50}ms`;
                
                const iconShape = q.type === 'multi' ? 'icon-check' : 'icon-radio';
                
                btn.innerHTML = `
                    <div class="flex items-start gap-3 pointer-events-none">
                        <div class="mt-0.5 w-5 h-5 border-2 border-gray-300 group-hover:border-brand-400 flex items-center justify-center transition-colors ${iconShape}">
                            <div class="w-2.5 h-2.5 bg-brand-500 opacity-0 transition-opacity ${iconShape} check-mark"></div>
                        </div>
                        <span class="flex-1 text-gray-700 font-medium leading-relaxed">${opt}</span>
                    </div>`;

                btn.onclick = () => {
                    // SINGLE
                    if (q.type !== 'multi') {
                        if(document.querySelector('.selected')) return; 
                        
                        document.querySelectorAll('.selected').forEach(el => {
                            el.classList.remove('selected', 'bg-brand-50', 'border-brand-500');
                            el.querySelector('.check-mark').classList.add('opacity-0');
                        });
                        
                        btn.classList.add('selected', 'bg-brand-50', 'border-brand-500');
                        btn.querySelector('.check-mark').classList.remove('opacity-0');
                        q.userSelected = opt;
                        
                        if(isStudy) reveal(q);
                        else {
                            actionBtn.innerText = "Submit Answer";
                            actionBtn.classList.remove('hidden');
                            actionBtn.onclick = () => reveal(q);
                        }
                    } 
                    // MULTI
                    else {
                        if(btn.disabled) return; 
                        
                        const isSelected = btn.classList.contains('selected');
                        if (isSelected) {
                            btn.classList.remove('selected', 'bg-brand-50', 'border-brand-500');
                            btn.querySelector('.check-mark').classList.add('opacity-0');
                            q.userSelected = q.userSelected.filter(item => item !== opt);
                        } else {
                            btn.classList.add('selected', 'bg-brand-50', 'border-brand-500');
                            btn.querySelector('.check-mark').classList.remove('opacity-0');
                            q.userSelected.push(opt);
                        }

                        if(q.userSelected.length > 0) {
                            actionBtn.innerText = "Submit Answer";
                            actionBtn.classList.remove('hidden');
                            actionBtn.onclick = () => reveal(q);
                        } else {
                            actionBtn.classList.add('hidden');
                        }
                    }
                };
                box.appendChild(btn);
            });
        }

        function reveal(q) {
            const opts = document.querySelectorAll('#options-area button');
            let isCorrect = false;

            if(q.type === 'multi') {
                const correctArr = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
                const userSorted = JSON.stringify(q.userSelected.sort());
                const correctSorted = JSON.stringify(correctArr.sort());
                isCorrect = (userSorted === correctSorted);
            } else {
                isCorrect = (q.userSelected === q.answer);
            }

            opts.forEach(b => {
                b.disabled = true; b.style.cursor = 'default';
                const text = b.innerText.trim();
                const isSelected = b.classList.contains('selected');
                
                let isThisCorrectOption = false;
                if(q.type === 'multi') {
                    const correctArr = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
                    isThisCorrectOption = correctArr.includes(text);
                } else {
                    isThisCorrectOption = (text === q.answer);
                }

                if (isThisCorrectOption) {
                    b.classList.remove('bg-white', 'bg-brand-50', 'border-brand-500', 'border-gray-100');
                    b.classList.add('bg-green-100', 'border-green-500', 'text-green-900');
                    if(!b.innerHTML.includes('ph-check')) {
                        b.innerHTML += `<i class="ph-bold ph-check text-green-600 absolute right-4 top-1/2 -translate-y-1/2 text-xl"></i>`;
                        b.classList.add('relative');
                    }
                } else if (isSelected && !isThisCorrectOption) {
                    b.classList.remove('bg-brand-50', 'border-brand-500');
                    b.classList.add('bg-red-100', 'border-red-500', 'text-red-900');
                } else {
                    b.classList.add('opacity-50');
                }
            });

            if(appState.mode === 'test' && isCorrect) appState.score++;

            document.getElementById('rationale-text').innerText = q.rationale || "No rationale.";
            document.getElementById('rationale-area').classList.remove('hidden');
            
            const btn = document.getElementById('action-btn');
            btn.innerText = "Next Question";
            btn.classList.remove('hidden');
            btn.onclick = nextCard;
        }

        function nextCard() {
            appState.index++;
            if(appState.index < appState.currentSet.length) loadCard();
            else {
                hideAll();
                document.getElementById('result-screen').classList.remove('hidden');
                const pct = Math.round((appState.score/appState.currentSet.length)*100);
                document.getElementById('score-val').innerText = pct+"%";
                if(pct >= 80) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
        }

        // --- ADMIN ---
        function openAdminPanel() {
            if(!appState.isAdmin) return showToast("Access Denied", "error");
            hideAll();
            document.getElementById('admin-screen').classList.remove('hidden');
            loadAdminList();
            resetAdminForm();
        }

        function setAdminTab(tab) {
            document.getElementById('admin-view-add').classList.toggle('hidden', tab !== 'add');
            document.getElementById('admin-view-bulk').classList.toggle('hidden', tab !== 'bulk');
            document.getElementById('admin-tab-add').className = tab==='add' ? "flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow" : "flex-1 py-2 rounded-lg text-xs font-bold text-gray-500";
            document.getElementById('admin-tab-bulk').className = tab==='bulk' ? "flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow" : "flex-1 py-2 rounded-lg text-xs font-bold text-gray-500";
        }

        // DYNAMIC OPTIONS LOGIC
        function addOption(text = "", isCorrect = false) {
            const container = document.getElementById('dynamic-options-container');
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 option-row animate-slide-up";
            
            div.innerHTML = `
                <div class="flex-1 relative">
                    <input type="text" class="adm-opt-input admin-input pr-10" placeholder="Option text..." value="${text.replace(/"/g, '&quot;')}">
                </div>
                <label class="cursor-pointer relative flex items-center justify-center w-10 h-10 hover:bg-gray-100 rounded-lg transition-colors" title="Mark as Correct">
                    <input type="checkbox" class="adm-check w-5 h-5 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer" ${isCorrect ? 'checked' : ''}>
                </label>
                <button onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 transition-colors p-2" title="Delete Option">
                    <i class="ph-bold ph-x"></i>
                </button>
            `;
            container.appendChild(div);
        }

        async function submitSingleQuestion() {
            const cat = document.getElementById('adm-cat').value;
            const sub = document.getElementById('adm-sub').value;
            const q = document.getElementById('adm-q').value;
            const rat = document.getElementById('adm-rat').value;

            // Gather Options
            const rows = document.querySelectorAll('.option-row');
            const opts = [];
            const correctValues = [];

            rows.forEach(row => {
                const val = row.querySelector('.adm-opt-input').value.trim();
                const checked = row.querySelector('.adm-check').checked;
                if(val) {
                    opts.push(val);
                    if(checked) correctValues.push(val);
                }
            });

            if(!cat || !sub || !q) return showToast("Missing details", "error");
            if(opts.length < 2) return showToast("Add at least 2 options", "error");
            if(correctValues.length === 0) return showToast("Select a correct answer", "error");

            let type = 'single';
            let finalAnswer = "";

            if (correctValues.length > 1) {
                type = 'multi';
                finalAnswer = JSON.stringify(correctValues);
            } else {
                type = 'single';
                finalAnswer = correctValues[0];
            }

            const payload = { category: cat, subject: sub, question: q, options: opts, answer: finalAnswer, rationale: rat, type: type };

            showLoading(true);
            let error;
            if (appState.editingId) {
                const res = await _supabase.from('questions').update(payload).eq('id', appState.editingId);
                error = res.error;
            } else {
                const res = await _supabase.from('questions').insert(payload);
                error = res.error;
            }
            showLoading(false);

            if(error) showToast("Failed to save", "error");
            else {
                showToast(appState.editingId ? "Updated!" : "Saved!");
                resetAdminForm();
                loadData();
            }
        }

        function editQuestion(id) {
            const q = appState.data.find(x => x.id == id);
            if(!q) return;

            appState.editingId = id;

            document.getElementById('adm-cat').value = q.category;
            document.getElementById('adm-sub').value = q.subject;
            document.getElementById('adm-q').value = q.question;
            document.getElementById('adm-rat').value = q.rationale;

            const container = document.getElementById('dynamic-options-container');
            container.innerHTML = ""; 

            let opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
            let correctArr = [];
            if(q.type === 'multi') {
                correctArr = typeof q.answer === 'string' ? JSON.parse(q.answer) : q.answer;
            } else {
                correctArr = [q.answer];
            }

            opts.forEach(optText => {
                const isCorrect = correctArr.includes(optText);
                addOption(optText, isCorrect);
            });

            const btn = document.getElementById('adm-submit-btn');
            btn.innerText = "Update Question";
            btn.className = "flex-1 bg-amber-500 text-white font-bold py-3 rounded-xl shadow hover:bg-amber-600 transition-colors";
            
            setAdminTab('add');
            showToast("Editing mode active");
        }

        function resetAdminForm() {
            appState.editingId = null;
            document.getElementById('adm-q').value = "";
            document.getElementById('adm-rat').value = "";
            
            const container = document.getElementById('dynamic-options-container');
            container.innerHTML = "";
            addOption(); addOption(); addOption(); addOption();
            
            const btn = document.getElementById('adm-submit-btn');
            btn.innerText = "Save Question";
            btn.className = "flex-1 bg-green-600 text-white font-bold py-3 rounded-xl shadow hover:bg-green-700 transition-colors";
        }

        async function submitBulk() {
            try {
                const json = JSON.parse(document.getElementById('adm-bulk-text').value);
                if(!Array.isArray(json)) throw new Error("Must be array");
                showLoading(true);
                const { error } = await _supabase.from('questions').insert(json);
                showLoading(false);
                if(error) throw error;
                showToast(`Uploaded ${json.length} items`);
                document.getElementById('adm-bulk-text').value = "";
                loadData();
            } catch(e) { showToast("Invalid JSON", "error"); showLoading(false); }
        }

        function loadAdminList() {
            const list = document.getElementById('admin-list');
            list.innerHTML = "";
            const recent = appState.data.slice(-10).reverse();
            recent.forEach(q => {
                list.innerHTML += `
                <div class="glass p-4 rounded-xl flex justify-between items-start animate-slide-up">
                    <div class="w-2/3">
                        <span class="text-[10px] uppercase font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded border border-brand-100">${q.category}</span>
                        <p class="text-sm font-bold mt-2 truncate text-gray-700">${q.question}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editQuestion('${q.id}')" class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 transition-colors"><i class="ph-bold ph-pencil-simple"></i></button>
                        <button onclick="deleteQuestion('${q.id}')" class="bg-red-50 text-red-500 p-2 rounded-lg hover:bg-red-100 transition-colors"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>`;
            });
        }

        async function deleteQuestion(id) {
            if(!confirm("Delete this question?")) return;
            showLoading(true);
            const { error } = await _supabase.from('questions').delete().eq('id', id);
            if(error) showToast("Delete failed", "error");
            else {
                appState.data = appState.data.filter(q => q.id != id); 
                loadAdminList();
                showToast("Deleted");
            }
            showLoading(false);
        }
    </script>
</body>
</html>
