<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Quiz Pro</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --text-main: #1f2937; --radius: 12px; }
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; color: var(--text-main); margin: 0; padding-top: 60px; }
        
        nav { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .nav-title { font-weight: 700; font-size: 1.2rem; color: var(--primary); margin-right: auto; }
        .nav-btn { background: none; border: none; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 0.9rem; padding: 8px 12px; border-radius: 6px; }
        .nav-btn:hover { background: #f3f4f6; color: var(--text-main); }

        .container { max-width: 500px; margin: 20px auto; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-align: center; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .hidden { display: none; }

        .option-btn { 
            background: #ffffff; 
            color: #1f2937 !important; 
            border: 2px solid #e5e7eb; 
            display: block; width: 100%; text-align: left; padding: 15px; margin-bottom: 12px; border-radius: 10px; cursor: pointer; font-size: 1rem; 
        }
        .option-btn:hover { border-color: #93c5fd; background: #f9fafb; }
        .option-btn.selected { background: var(--primary); color: white !important; border-color: var(--primary); }

        .review-item { text-align: left; background: #fef2f2; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ef4444; }
        .review-q { font-weight: 700; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <nav>
        <span class="nav-title">ü©∫ QuizApp</span>
        <button id="home-btn" class="nav-btn hidden" onclick="goHome()">üè† Home</button>
    </nav>

    <div class="container">
        <div id="loading-screen" class="card">
            <h2>Connecting...</h2>
            <p>Fetching database from Supabase.</p>
        </div>

        <div id="start-screen" class="card hidden">
            <h1 style="margin-top:0;">Pick a Topic</h1>
            <p style="color:#666; margin-bottom:20px;">Choose a subject to generate a 10-question practice set.</p>
            <select id="subject-select" style="width:100%; padding:12px; margin-bottom:20px; font-size:1rem; border-radius:8px; border:2px solid #e5e7eb;">
                </select>
            <button onclick="startQuiz()">Start Quiz</button>
        </div>

        <div id="quiz-screen" class="card hidden">
            <div style="display:flex; justify-content:space-between; color:#666; font-size:0.9rem; margin-bottom:15px;">
                <span id="topic-badge">Anatomy</span>
                <span id="q-progress">1/10</span>
            </div>
            <h2 id="q-header" style="font-size:1.3rem; margin-bottom:25px; line-height:1.4;"></h2>
            <div id="options-container"></div>
            <button id="next-btn" onclick="nextQuestion()" class="hidden" style="margin-top:20px;">Confirm & Next</button>
        </div>

        <div id="result-screen" class="card hidden">
            <h2>Session Complete</h2>
            <div style="font-size:3rem; font-weight:800; color:var(--primary); margin:10px 0;" id="score-display">0%</div>
            <p id="score-msg">Good job!</p>
            <div id="review-container" style="margin-top:30px;"></div>
            <button onclick="goHome()" style="margin-top:20px;">Start New Quiz</button>
        </div>
    </div>

    <script>
        // --- CONFIGURE SUPABASE HERE ---
        const SUPABASE_URL = "https://ilsmjyvpduvmkxoxcqin.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_7ZI3V6f0ckuxpASg3febTw_E_oxey_I";
        
        // Initialize Client
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let questionBank = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;

        // 1. FETCH DATA ON LOAD
        window.onload = async function() {
            try {
                // Fetch from 'questions' table
                let { data, error } = await _supabase
                    .from('questions')
                    .select('*');

                if (error) throw error;
                
                questionBank = data;
                
                if(questionBank.length === 0) {
                    alert("Database connected, but the table is empty! Add a row in Supabase.");
                } else {
                    loadSubjects();
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('start-screen').classList.remove('hidden');
                    document.getElementById('home-btn').classList.remove('hidden');
                }

            } catch (err) {
                console.error("Error:", err);
                document.querySelector('#loading-screen h2').innerText = "Connection Failed";
                document.querySelector('#loading-screen p').innerText = "Check your Supabase URL/Key in index.html";
            }
        };

        function loadSubjects() {
            const subjects = [...new Set(questionBank.map(q => q.subject))];
            const select = document.getElementById('subject-select');
            select.innerHTML = '<option value="All">Mix All Subjects</option>';
            subjects.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.innerText = sub;
                select.appendChild(opt);
            });
        }

        // --- NAVIGATION LOGIC ---
        function goHome() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

        function startQuiz() {
            const subject = document.getElementById('subject-select').value;
            let filtered = subject === "All" ? questionBank : questionBank.filter(q => q.subject === subject);
            
            if(filtered.length === 0) { alert("No questions found!"); return; }
            
            currentQuestions = filtered.sort(() => 0.5 - Math.random()).slice(0, 10);
            currentIndex = 0; score = 0;
            
            document.getElementById('topic-badge').innerText = subject;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuestions[currentIndex];
            document.getElementById('q-progress').innerText = `${currentIndex + 1}/${currentQuestions.length}`;
            document.getElementById('q-header').innerText = q.question;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            document.getElementById('next-btn').classList.add('hidden');

            // Handle options (parse if it's a string, use directly if object)
            let opts = q.options;
            if (typeof opts === 'string') opts = JSON.parse(opts);

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    q.userSelected = opt;
                    document.getElementById('next-btn').classList.remove('hidden');
                };
                container.appendChild(btn);
            });
        }

        function nextQuestion() {
            if(currentQuestions[currentIndex].userSelected === currentQuestions[currentIndex].answer) score++;
            currentIndex++;
            if(currentIndex < currentQuestions.length) loadQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            const percent = Math.round((score/currentQuestions.length)*100);
            document.getElementById('score-display').innerText = percent + "%";
            document.getElementById('score-msg').innerText = percent > 70 ? "Great job! üéâ" : "Keep practicing! üí™";

            const container = document.getElementById('review-container');
            container.innerHTML = '';
            
            const wrong = currentQuestions.filter(q => q.userSelected !== q.answer);
            if(wrong.length === 0) {
                container.innerHTML = "<p style='color:green;'>Perfect score! No mistakes to review.</p>";
            } else {
                wrong.forEach(q => {
                    container.innerHTML += `
                    <div class="review-item">
                        <span class="review-q">${q.question}</span>
                        <div style="font-size:0.9rem;">
                            <span style="color:#ef4444; text-decoration:line-through;">${q.userSelected}</span> 
                            <span style="color:#059669; font-weight:bold; margin-left:10px;">‚ûú ${q.answer}</span>
                        </div>
                        <p style="font-size:0.85rem; color:#666; margin-top:5px; font-style:italic;">üí° ${q.rationale}</p>
                    </div>`;
                });
            }
        }
    </script>
</body>
</html>
