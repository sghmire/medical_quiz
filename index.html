<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Nursing Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --text-main: #1f2937; --radius: 16px; }
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; color: var(--text-main); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 100%; max-width: 500px; padding: 40px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-align: center; }
        input { width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; text-align: center; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .hidden { display: none; }
        .option-btn { background: #fff; border: 2px solid #e5e7eb; display: block; width:100%; text-align: left; padding: 12px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; }
        .option-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .review-item { text-align: left; background: #f9fafb; padding: 15px; margin-bottom: 10px; border-left: 4px solid #ef4444; }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h2>ðŸ”’ Secure Database</h2>
        <p>Enter password to decrypt questions:</p>
        <input type="password" id="password-input" placeholder="Password">
        <button onclick="unlockDatabase()">Decrypt & Enter</button>
        <p id="status-msg" style="margin-top:10px; color:#666; font-size:0.9rem;"></p>
    </div>

    <div id="start-screen" class="card hidden">
        <h1>Topic Selection</h1>
        <select id="subject-select" style="width:100%; padding:10px; margin-bottom:20px;"></select>
        <button onclick="startQuiz()">Start Quiz</button>
    </div>

    <div id="quiz-screen" class="card hidden">
        <h2 id="q-header"></h2>
        <p id="q-text" style="font-size:1.1rem; margin-bottom:20px;"></p>
        <div id="options-container"></div>
        <button id="next-btn" onclick="nextQuestion()" class="hidden" style="margin-top:20px;">Next</button>
    </div>

    <div id="result-screen" class="card hidden">
        <h2>Result</h2>
        <h1 id="score-display">0%</h1>
        <div id="review-container"></div>
        <button onclick="location.reload()" style="margin-top:20px;">Restart</button>
    </div>

    <script>
        let questionBank = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;

        async function unlockDatabase() {
            const status = document.getElementById('status-msg');
            const password = document.getElementById('password-input').value;
            status.innerText = "Downloading encrypted file...";

            try {
                // 1. Fetch the ENCRYPTED file
                const response = await fetch('questions.json');
                const encryptedText = await response.text(); // Get raw text
                
                status.innerText = "Decrypting...";

                // 2. Decrypt it using the password input
                const bytes = CryptoJS.AES.decrypt(encryptedText, password);
                const decryptedData = bytes.toString(CryptoJS.enc.Utf8);

                if (!decryptedData) throw new Error("Wrong Password");

                // 3. Parse JSON
                questionBank = JSON.parse(decryptedData);
                
                // 4. Success! Load App
                loadSubjects();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                status.innerText = "âŒ Decryption Failed. Wrong password or corrupted file.";
                status.style.color = "red";
            }
        }

        function loadSubjects() {
            const subjects = [...new Set(questionBank.map(q => q.subject))];
            const select = document.getElementById('subject-select');
            select.innerHTML = '<option value="All">Mix All Subjects</option>';
            subjects.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.innerText = sub;
                select.appendChild(opt);
            });
        }

        // --- STANDARD QUIZ LOGIC ---
        function startQuiz() {
            const subject = document.getElementById('subject-select').value;
            let filtered = subject === "All" ? questionBank : questionBank.filter(q => q.subject === subject);
            if(filtered.length === 0) { alert("No questions!"); return; }
            currentQuestions = filtered.sort(() => 0.5 - Math.random()).slice(0, 10);
            currentIndex = 0; score = 0;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuestions[currentIndex];
            document.getElementById('q-header').innerText = `Q ${currentIndex + 1}/${currentQuestions.length}`;
            document.getElementById('q-text').innerText = q.question;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            document.getElementById('next-btn').classList.add('hidden');
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    q.userSelected = opt;
                    document.getElementById('next-btn').classList.remove('hidden');
                };
                container.appendChild(btn);
            });
        }

        function nextQuestion() {
            if(currentQuestions[currentIndex].userSelected === currentQuestions[currentIndex].answer) score++;
            currentIndex++;
            if(currentIndex < currentQuestions.length) loadQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('score-display').innerText = Math.round((score/currentQuestions.length)*100) + "%";
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            currentQuestions.filter(q => q.userSelected !== q.answer).forEach(q => {
                container.innerHTML += `<div class="review-item"><p><strong>${q.question}</strong><br>You: ${q.userSelected}<br>Correct: ${q.answer}</p></div>`;
            });
        }
    </script>
</body>
</html>
