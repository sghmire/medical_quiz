<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuizPro | Admin Enabled</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed; background-size: cover; min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-dark { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
        .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Admin Input Style */
        .admin-input { width: 100%; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; transition: all 0.2s; }
        .admin-input:focus { outline: none; border-color: #3b82f6; ring: 2px; }
    </style>
</head>
<body class="text-gray-800 antialiased pb-20">

    <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <nav class="fixed top-4 left-1/2 -translate-x-1/2 w-[95%] max-w-4xl glass rounded-full shadow-lg z-50 px-5 py-3 flex items-center justify-between transition-all">
        <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
            <div class="bg-brand-600 text-white p-1.5 rounded-lg"><i class="ph-bold ph-heartbeat text-xl"></i></div>
            <span class="font-bold text-lg tracking-tight hidden sm:block">Quiz<span class="text-brand-600">Pro</span></span>
        </div>
        
        <div id="nav-user" class="hidden flex items-center gap-3">
            <button id="nav-admin-btn" onclick="openAdminPanel()" class="hidden bg-gray-900 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-black transition-colors flex items-center gap-1">
                <i class="ph-bold ph-gear"></i> ADMIN
            </button>
            <span id="display-user" class="text-xs font-bold text-gray-600 uppercase tracking-wider hidden sm:block"></span>
            <button onclick="signOut()" class="text-gray-400 hover:text-red-500 p-1"><i class="ph-bold ph-sign-out text-xl"></i></button>
        </div>
    </nav>

    <div class="container max-w-lg mx-auto px-4 pt-32 relative z-10">

        <div id="auth-screen" class="glass rounded-3xl shadow-2xl p-8 animate-slide-up">
            <h1 id="auth-title" class="text-3xl font-extrabold text-gray-900 mb-2 text-center">Welcome</h1>
            <p class="text-gray-500 text-sm text-center mb-8">Sign in to start learning.</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="admin-input" autocomplete="off">
                <input type="password" id="password" placeholder="Password" class="admin-input">
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">Log In</button>
            </div>
            <div class="mt-6 text-center">
                <button onclick="toggleAuthMode()" id="toggle-link" class="text-sm font-semibold text-gray-500 hover:text-brand-600">Create Account</button>
            </div>
        </div>

        <div id="dashboard-screen" class="hidden animate-slide-up">
            <div class="glass p-1.5 rounded-2xl flex mb-8 shadow-lg">
                <button onclick="setMode('study')" id="tab-study" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white text-brand-600 shadow-md">STUDY</button>
                <button onclick="setMode('test')" id="tab-test" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500">TEST</button>
            </div>
            <div id="categories-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="submenu-screen" class="hidden animate-slide-up">
            <div class="flex items-center justify-between mb-6 text-white">
                <button onclick="goHome()" class="w-10 h-10 rounded-full glass-dark flex items-center justify-center"><i class="ph-bold ph-arrow-left"></i></button>
                <h2 id="submenu-title" class="text-xl font-bold">Topics</h2>
                <div class="w-10"></div>
            </div>
            <div id="topics-grid" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="session-screen" class="hidden">
            <div class="glass rounded-3xl shadow-xl overflow-hidden animate-slide-up min-h-[500px] flex flex-col">
                <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-b border-gray-100">
                    <button onclick="goSubmenu()" class="text-gray-400 text-sm font-bold flex items-center gap-1">QUIT</button>
                    <span id="session-progress" class="text-xs font-bold text-gray-500">1/10</span>
                </div>
                <div class="p-6 md:p-8 flex-1 flex flex-col">
                    <h2 id="q-text" class="text-xl font-bold text-gray-800 leading-snug mb-8"></h2>
                    <div id="options-area" class="space-y-3 mb-6"></div>
                    <div id="rationale-area" class="hidden rounded-xl bg-blue-50 border border-blue-100 p-5 mb-4"><p id="rationale-text" class="text-blue-900 text-sm"></p></div>
                    <button id="action-btn" class="hidden w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg">Continue</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden text-center animate-slide-up pt-10">
            <div class="glass rounded-3xl p-8 shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Complete!</h2>
                <div class="text-5xl font-extrabold text-brand-600 my-6" id="score-val">0%</div>
                <button onclick="goSubmenu()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3.5 rounded-xl">Back</button>
            </div>
        </div>

        <div id="admin-screen" class="hidden animate-slide-up">
            <div class="flex items-center justify-between mb-6 text-white">
                <button onclick="goHome()" class="w-10 h-10 rounded-full glass-dark flex items-center justify-center"><i class="ph-bold ph-arrow-left"></i></button>
                <h2 class="text-xl font-bold">Admin Panel</h2>
                <div class="w-10"></div>
            </div>

            <div class="glass p-1.5 rounded-xl flex mb-6">
                <button onclick="setAdminTab('add')" id="admin-tab-add" class="flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow">Add New</button>
                <button onclick="setAdminTab('bulk')" id="admin-tab-bulk" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500">Bulk JSON</button>
            </div>

            <div id="admin-view-add" class="glass p-6 rounded-3xl">
                <h3 class="font-bold text-lg mb-4">Create Question</h3>
                <div class="space-y-3">
                    <input id="adm-cat" class="admin-input" placeholder="Category (e.g. Pharmacology)">
                    <input id="adm-sub" class="admin-input" placeholder="Subject (e.g. Week 1)">
                    <textarea id="adm-q" class="admin-input h-24" placeholder="Question Text"></textarea>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <input id="adm-opt-1" class="admin-input" placeholder="Option A">
                        <input id="adm-opt-2" class="admin-input" placeholder="Option B">
                        <input id="adm-opt-3" class="admin-input" placeholder="Option C">
                        <input id="adm-opt-4" class="admin-input" placeholder="Option D">
                    </div>

                    <select id="adm-ans" class="admin-input">
                        <option value="" disabled selected>Select Correct Answer...</option>
                        <option value="0">Option A</option>
                        <option value="1">Option B</option>
                        <option value="2">Option C</option>
                        <option value="3">Option D</option>
                    </select>

                    <textarea id="adm-rat" class="admin-input h-20" placeholder="Rationale (Explanation)"></textarea>
                    
                    <button onclick="submitSingleQuestion()" id="adm-submit-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow hover:bg-green-700 transition-colors">Save Question</button>
                </div>
            </div>

            <div id="admin-view-bulk" class="glass p-6 rounded-3xl hidden">
                <h3 class="font-bold text-lg mb-2">Bulk Upload</h3>
                <p class="text-xs text-gray-500 mb-4">Paste a JSON array of question objects.</p>
                <textarea id="adm-bulk-text" class="admin-input h-64 font-mono text-xs" placeholder='[{"category":"...","question":"...","options":["A","B"],"answer":"A","rationale":"..."}]'></textarea>
                <button onclick="submitBulk()" class="w-full mt-4 bg-brand-600 text-white font-bold py-3 rounded-xl shadow">Upload JSON</button>
            </div>

            <div class="mt-8">
                <h3 class="text-white font-bold mb-4">Recent Questions</h3>
                <div id="admin-list" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <div id="loading-screen" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="loader"></div>
        <div class="text-white mt-4 font-bold">Loading...</div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://ilsmjyvpduvmkxoxcqin.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_7ZI3V6f0ckuxpASg3febTw_E_oxey_I";
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let appState = { 
            data: [], user: null, isAdmin: false,
            currentSet: [], index: 0, score: 0, mode: 'study', isSignUp: false,
            editingId: null 
        };

        // --- UTILS ---
        function showToast(msg, type='success') {
            const el = document.createElement('div');
            el.className = `${type==='error'?'bg-red-500':'bg-green-500'} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 text-sm font-bold pointer-events-auto animate-slide-up`;
            el.innerHTML = `<i class="ph-bold ${type==='error'?'ph-warning-circle':'ph-check-circle'}"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function showLoading(show) {
            document.getElementById('loading-screen').classList.toggle('hidden', !show);
        }

        // --- AUTH ---
        window.onload = () => {
            const u = localStorage.getItem('quizUser');
            if(u) handleAuth(u, localStorage.getItem('quizPass'), true); // Auto-login
        };

        async function handleAuth(uInput, pInput, isAuto = false) {
            const u = uInput || document.getElementById('username').value.trim();
            const p = pInput || document.getElementById('password').value.trim();
            if(!u || !p) return showToast("Enter credentials", "error");

            if(!isAuto) showLoading(true);

            try {
                if(appState.isSignUp && !isAuto) {
                    // Sign Up Logic
                    const { data } = await _supabase.from('users').select('*').eq('username', u);
                    if(data.length) throw new Error("Username taken");
                    const { error } = await _supabase.from('users').insert({ username: u, password: p, is_admin: false }); // Default not admin
                    if(error) throw error;
                    showToast("Account created!");
                } 
                
                // Log In Logic
                const { data, error } = await _supabase.from('users').select('*').eq('username', u).eq('password', p);
                if(error || !data.length) throw new Error("Invalid login");

                // Success
                appState.user = u;
                appState.isAdmin = data[0].is_admin; // CHECK DATABASE COLUMN
                
                localStorage.setItem('quizUser', u);
                localStorage.setItem('quizPass', p); // Storing plain text pass in local storage is weak security, but fits this prototype.

                if(appState.isAdmin) {
                    document.getElementById('nav-admin-btn').classList.remove('hidden');
                    showToast(`Welcome Admin ${u}`);
                }

                loadData();
            } catch (e) {
                showToast(e.message, "error");
                showLoading(false);
            }
        }

        function toggleAuthMode() {
            appState.isSignUp = !appState.isSignUp;
            document.getElementById('auth-title').innerText = appState.isSignUp ? "Create Account" : "Welcome";
            document.getElementById('auth-btn').innerText = appState.isSignUp ? "Sign Up" : "Log In";
            document.getElementById('toggle-link').innerText = appState.isSignUp ? "Back to Login" : "Create Account";
        }

        function signOut() {
            localStorage.clear(); location.reload();
        }

        // --- DATA LOADING ---
        async function loadData() {
            try {
                const { data } = await _supabase.from('questions').select('*');
                appState.data = data || [];
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('nav-user').classList.remove('hidden');
                document.getElementById('display-user').innerText = appState.user;
                
                showLoading(false);
                goHome();
            } catch(e) { showToast("Error loading data", "error"); showLoading(false); }
        }

        // --- NAVIGATION ---
        function hideAll() {
            ['dashboard-screen','submenu-screen','session-screen','result-screen','admin-screen'].forEach(id => 
                document.getElementById(id).classList.add('hidden'));
        }

        function goHome() {
            hideAll();
            document.getElementById('dashboard-screen').classList.remove('hidden');
            renderDashboard();
        }

        function renderDashboard() {
            const cats = [...new Set(appState.data.map(q => q.category || 'General'))].sort();
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = "";
            cats.forEach(cat => {
                const count = appState.data.filter(q => (q.category||'General') === cat).length;
                grid.innerHTML += `
                <div onclick="openCategory('${cat}')" class="glass p-5 rounded-2xl cursor-pointer hover:bg-white transition-all">
                    <div class="w-10 h-10 rounded-lg bg-brand-100 text-brand-600 flex items-center justify-center mb-3 text-xl"><i class="ph-duotone ph-books"></i></div>
                    <h3 class="font-bold">${cat}</h3>
                    <p class="text-xs text-gray-500">${count} Qs</p>
                </div>`;
            });
        }

        function openCategory(cat) {
            hideAll();
            document.getElementById('submenu-screen').classList.remove('hidden');
            document.getElementById('submenu-title').innerText = cat;
            const subs = [...new Set(appState.data.filter(q=>(q.category||'General')===cat).map(q=>q.subject))].sort();
            const grid = document.getElementById('topics-grid');
            grid.innerHTML = "";
            subs.forEach(sub => {
                grid.innerHTML += `<div onclick="startSession('${sub}')" class="glass p-4 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white"><span class="font-bold text-gray-700">${sub}</span><i class="ph-bold ph-caret-right text-gray-400"></i></div>`;
            });
        }

        // --- QUIZ LOGIC ---
        function startSession(sub) {
            appState.currentSet = appState.data.filter(q => q.subject === sub).sort(()=>0.5-Math.random()).slice(0,15);
            appState.index = 0; appState.score = 0;
            hideAll();
            document.getElementById('session-screen').classList.remove('hidden');
            loadCard();
        }

        function loadCard() {
            const q = appState.currentSet[appState.index];
            document.getElementById('q-text').innerText = q.question;
            document.getElementById('session-progress').innerText = `${appState.index+1}/${appState.currentSet.length}`;
            document.getElementById('rationale-area').classList.add('hidden');
            document.getElementById('action-btn').classList.add('hidden');
            
            const box = document.getElementById('options-area');
            box.innerHTML = "";
            let opts = typeof q.options==='string'?JSON.parse(q.options):q.options;
            
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl bg-white border border-gray-100 hover:border-brand-500 transition-all shadow-sm";
                btn.innerText = opt;
                btn.onclick = () => {
                    if(document.querySelector('.selected')) return;
                    btn.classList.add('selected','bg-brand-50','border-brand-500');
                    q.userSelected = opt;
                    if(appState.mode === 'study') reveal(q, btn);
                    else { document.getElementById('action-btn').classList.remove('hidden'); document.getElementById('action-btn').onclick = nextCard; }
                }
                box.appendChild(btn);
            });
        }

        function reveal(q, btn) {
            const opts = document.querySelectorAll('#options-area button');
            opts.forEach(b => {
                if(b.innerText === q.answer) { b.classList.remove('bg-white'); b.classList.add('bg-green-100','border-green-500','text-green-800'); }
                else if(b === btn) { b.classList.remove('bg-brand-50'); b.classList.add('bg-red-100','border-red-500','text-red-800'); }
            });
            document.getElementById('rationale-text').innerText = q.rationale || "No rationale.";
            document.getElementById('rationale-area').classList.remove('hidden');
            document.getElementById('action-btn').classList.remove('hidden');
            document.getElementById('action-btn').onclick = nextCard;
        }

        function nextCard() {
            if(appState.mode==='test' && appState.currentSet[appState.index].userSelected === appState.currentSet[appState.index].answer) appState.score++;
            appState.index++;
            if(appState.index < appState.currentSet.length) loadCard();
            else {
                hideAll();
                document.getElementById('result-screen').classList.remove('hidden');
                document.getElementById('score-val').innerText = Math.round((appState.score/appState.currentSet.length)*100)+"%";
            }
        }

        function goSubmenu() { if(appState.currentCategory) openCategory(appState.currentCategory); else goHome(); }
        function setMode(m) { 
            appState.mode = m; 
            document.getElementById('tab-study').className = m==='study' ? "flex-1 py-3 rounded-xl text-sm font-bold bg-white text-brand-600 shadow-md" : "flex-1 py-3 rounded-xl text-sm font-bold text-gray-500";
            document.getElementById('tab-test').className = m==='test' ? "flex-1 py-3 rounded-xl text-sm font-bold bg-white text-brand-600 shadow-md" : "flex-1 py-3 rounded-xl text-sm font-bold text-gray-500";
        }

        // --- ADMIN LOGIC ---
        function openAdminPanel() {
            if(!appState.isAdmin) return showToast("Access Denied", "error");
            hideAll();
            document.getElementById('admin-screen').classList.remove('hidden');
            loadAdminList();
        }

        function setAdminTab(tab) {
            document.getElementById('admin-view-add').classList.toggle('hidden', tab !== 'add');
            document.getElementById('admin-view-bulk').classList.toggle('hidden', tab !== 'bulk');
            document.getElementById('admin-tab-add').className = tab==='add' ? "flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow" : "flex-1 py-2 rounded-lg text-xs font-bold text-gray-500";
            document.getElementById('admin-tab-bulk').className = tab==='bulk' ? "flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow" : "flex-1 py-2 rounded-lg text-xs font-bold text-gray-500";
        }

        async function submitSingleQuestion() {
            const cat = document.getElementById('adm-cat').value;
            const sub = document.getElementById('adm-sub').value;
            const q = document.getElementById('adm-q').value;
            const opts = [
                document.getElementById('adm-opt-1').value,
                document.getElementById('adm-opt-2').value,
                document.getElementById('adm-opt-3').value,
                document.getElementById('adm-opt-4').value
            ].filter(o => o.trim() !== "");
            
            const ansIndex = document.getElementById('adm-ans').value;
            const rat = document.getElementById('adm-rat').value;
        
            if(!cat || !sub || !q || opts.length < 2 || !ansIndex) return showToast("Fill all fields", "error");
        
            const payload = {
                category: cat,
                subject: sub,
                question: q,
                options: opts,
                answer: opts[parseInt(ansIndex)],
                rationale: rat
            };
        
            showLoading(true);
        
            let error;
            
            // --- CHECK: ARE WE EDITING OR CREATING? ---
            if (appState.editingId) {
                // UPDATE EXISTING
                const res = await _supabase.from('questions').update(payload).eq('id', appState.editingId);
                error = res.error;
            } else {
                // CREATE NEW
                const res = await _supabase.from('questions').insert(payload);
                error = res.error;
            }
        
            showLoading(false);
        
            if(error) {
                showToast("Failed to save", "error");
            } else {
                showToast(appState.editingId ? "Updated successfully!" : "Question Added!");
                resetAdminForm(); // Clear inputs
                loadData(); // Fetch new data
                // We don't call loadAdminList here because loadData will trigger a refresh eventually, 
                // or we can wait for the user to navigate.
            }
        }

        async function submitBulk() {
            const txt = document.getElementById('adm-bulk-text').value;
            try {
                const json = JSON.parse(txt);
                if(!Array.isArray(json)) throw new Error("Must be an array [...]");
                
                showLoading(true);
                const { error } = await _supabase.from('questions').insert(json);
                showLoading(false);
                
                if(error) throw error;
                showToast(`Uploaded ${json.length} questions!`);
                document.getElementById('adm-bulk-text').value = "";
                loadData();
                loadAdminList();
            } catch(e) {
                showToast("Invalid JSON: " + e.message, "error");
                showLoading(false);
            }
        }

        function loadAdminList() {
            const list = document.getElementById('admin-list');
            list.innerHTML = "";
            const recent = appState.data.slice(-10).reverse();
            
            recent.forEach(q => {
                list.innerHTML += `
                <div class="glass p-4 rounded-xl flex justify-between items-start animate-slide-up">
                    <div class="w-2/3">
                        <span class="text-[10px] uppercase font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded">${q.category}</span>
                        <p class="text-sm font-bold mt-2 truncate">${q.question}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editQuestion('${q.id}')" class="bg-blue-100 text-blue-600 p-2 rounded-lg hover:bg-blue-200 transition-colors">
                            <i class="ph-bold ph-pencil-simple"></i>
                        </button>
                        <button onclick="deleteQuestion('${q.id}')" class="bg-red-100 text-red-500 p-2 rounded-lg hover:bg-red-200 transition-colors">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                </div>`;
            });
        }

        async function deleteQuestion(id) {
            if(!confirm("Delete this question?")) return;
            showLoading(true);
            const { error } = await _supabase.from('questions').delete().eq('id', id);
            if(error) showToast("Delete failed", "error");
            else {
                showToast("Deleted");
                // Remove from local state manually to avoid full reload
                appState.data = appState.data.filter(q => q.id != id); 
                loadAdminList();
            }
            showLoading(false);
        }

        function editQuestion(id) {
                const q = appState.data.find(x => x.id == id);
                if(!q) return;
            
                appState.editingId = id; // Turn on "Edit Mode"
            
                // 1. Populate the form fields
                document.getElementById('adm-cat').value = q.category;
                document.getElementById('adm-sub').value = q.subject;
                document.getElementById('adm-q').value = q.question;
                document.getElementById('adm-rat').value = q.rationale;
            
                // 2. Handle Options (JSON parsing safety)
                let opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
                document.getElementById('adm-opt-1').value = opts[0] || "";
                document.getElementById('adm-opt-2').value = opts[1] || "";
                document.getElementById('adm-opt-3').value = opts[2] || "";
                document.getElementById('adm-opt-4').value = opts[3] || "";
            
                // 3. Set the Correct Answer Select Box
                // We have to find which index matches the answer string
                const ansIndex = opts.indexOf(q.answer);
                if(ansIndex > -1) document.getElementById('adm-ans').value = ansIndex;
            
                // 4. Change UI to look like "Edit Mode"
                const btn = document.getElementById('adm-submit-btn');
                btn.innerText = "Update Question";
                btn.className = "w-full bg-amber-500 text-white font-bold py-3 rounded-xl shadow hover:bg-amber-600 transition-colors";
                
                // 5. Switch to "Add" tab automatically so user sees the form
                setAdminTab('add');
                document.getElementById('adm-cat').focus();
                showToast("Editing mode active", "success");
          }

        function resetAdminForm() {
                appState.editingId = null;
                document.getElementById('adm-q').value = "";
                document.getElementById('adm-opt-1').value = "";
                document.getElementById('adm-opt-2').value = "";
                document.getElementById('adm-opt-3').value = "";
                document.getElementById('adm-opt-4').value = "";
                document.getElementById('adm-rat').value = "";
                document.getElementById('adm-ans').value = ""; // Reset select
                
                // Reset Button Style
                const btn = document.getElementById('adm-submit-btn');
                btn.innerText = "Save Question";
                btn.className = "w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow hover:bg-green-700 transition-colors";
            }

    </script>
</body>
</html>
