<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuizPro | Modern Learning</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        surface: '#ffffff',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern Background Gradient */
        body {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .loader {
            width: 20px; height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 antialiased selection:bg-brand-500 selection:text-white pb-20">

    <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <nav class="fixed top-4 left-1/2 -translate-x-1/2 w-[95%] max-w-4xl glass rounded-full shadow-lg z-50 px-6 py-3 flex items-center justify-between transition-all duration-300">
        <div class="flex items-center gap-2 cursor-pointer group" onclick="goHome()">
            <div class="bg-brand-600 text-white p-1.5 rounded-lg group-hover:rotate-12 transition-transform">
                <i class="ph-bold ph-heartbeat text-xl"></i>
            </div>
            <span class="font-bold text-lg tracking-tight text-gray-900">Quiz<span class="text-brand-600">Pro</span></span>
        </div>
        
        <div id="nav-user" class="hidden flex items-center gap-3">
            <div class="hidden sm:flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span id="display-user" class="text-xs font-bold text-gray-600 uppercase tracking-wider"></span>
            </div>
            <button onclick="signOut()" class="text-gray-400 hover:text-red-500 transition-colors p-1" title="Sign Out">
                <i class="ph-bold ph-sign-out text-xl"></i>
            </button>
        </div>
    </nav>

    <div class="container max-w-lg mx-auto px-4 pt-32 relative z-10">

        <div id="auth-screen" class="glass rounded-3xl shadow-2xl p-8 animate-slide-up">
            <div class="text-center mb-8">
                <div class="bg-brand-50 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-600 animate-float">
                    <i class="ph-duotone ph-student text-3xl"></i>
                </div>
                <h1 id="auth-title" class="text-3xl font-extrabold text-gray-900 mb-2">Welcome Back</h1>
                <p class="text-gray-500 text-sm">Enter your credentials to access your dashboard.</p>
            </div>

            <div class="space-y-4">
                <div class="group relative">
                    <i class="ph-duotone ph-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-600 transition-colors"></i>
                    <input type="text" id="username" placeholder="Username" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3.5 pl-11 pr-4 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:bg-white transition-all font-medium" autocomplete="off">
                </div>
                <div class="group relative">
                    <i class="ph-duotone ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-600 transition-colors"></i>
                    <input type="password" id="password" placeholder="Password" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3.5 pl-11 pr-4 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:bg-white transition-all font-medium">
                </div>
                
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <span>Log In</span> <i class="ph-bold ph-arrow-right"></i>
                </button>
            </div>

            <div class="mt-6 text-center">
                <button onclick="toggleAuthMode()" id="toggle-link" class="text-sm font-semibold text-gray-500 hover:text-brand-600 transition-colors">
                    New here? Create an account
                </button>
            </div>
        </div>

        <div id="loading-screen" class="hidden flex flex-col items-center justify-center py-20 animate-fade-in">
            <div class="relative w-20 h-20">
                <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-brand-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <h2 class="mt-6 text-white font-semibold text-lg tracking-wide">Syncing Data...</h2>
        </div>

        <div id="dashboard-screen" class="hidden animate-slide-up">
            <div class="glass p-1.5 rounded-2xl flex mb-8 shadow-lg">
                <button onclick="setMode('study')" id="tab-study" class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-white text-brand-600 shadow-md transform scale-100">
                    <i class="ph-bold ph-book-open"></i> STUDY
                </button>
                <button onclick="setMode('test')" id="tab-test" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 flex items-center justify-center gap-2 hover:text-gray-700 transition-all">
                    <i class="ph-bold ph-exam"></i> TEST
                </button>
            </div>

            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-1">Explore Courses</h2>
                <p class="text-blue-200 text-sm">Select a category to begin</p>
            </div>

            <div id="categories-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="submenu-screen" class="hidden animate-slide-up">
            <div class="flex items-center justify-between mb-6 text-white">
                <button onclick="goHome()" class="w-10 h-10 rounded-full glass-dark flex items-center justify-center hover:bg-white hover:text-brand-900 transition-all">
                    <i class="ph-bold ph-arrow-left"></i>
                </button>
                <h2 id="submenu-title" class="text-xl font-bold">Topics</h2>
                <div class="w-10"></div>
            </div>
            <div id="topics-grid" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="session-screen" class="hidden w-full">
            <div class="glass rounded-3xl shadow-xl overflow-hidden animate-slide-up min-h-[500px] flex flex-col">
                <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-b border-gray-100">
                    <button onclick="goSubmenu()" class="text-gray-400 hover:text-gray-700 transition-colors text-sm font-bold flex items-center gap-1">
                        <i class="ph-bold ph-x"></i> QUIT
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-brand-500 transition-all duration-500 w-[10%]"></div>
                        </div>
                        <span id="session-progress" class="text-xs font-bold text-gray-500">1/10</span>
                    </div>
                </div>

                <div class="p-6 md:p-8 flex-1 flex flex-col">
                    <h2 id="q-text" class="text-xl md:text-2xl font-bold text-gray-800 leading-snug mb-8"></h2>
                    
                    <div id="options-area" class="space-y-3 mb-6"></div>
                    
                    <div id="rationale-area" class="hidden rounded-xl bg-blue-50 border border-blue-100 p-5 animate-fade-in relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <h4 class="text-blue-800 font-bold text-sm mb-1 flex items-center gap-2">
                            <i class="ph-fill ph-lightbulb"></i> Rationale
                        </h4>
                        <p id="rationale-text" class="text-blue-900 text-sm leading-relaxed"></p>
                    </div>

                    <div class="flex-1"></div> <button id="action-btn" class="hidden w-full mt-6 bg-gray-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 animate-slide-up">
                        <span>Continue</span> <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden text-center animate-slide-up pt-10">
            <div class="glass rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-32 bg-brand-500/20 blur-3xl rounded-full pointer-events-none"></div>

                <h2 class="text-2xl font-bold text-gray-900 mb-2">Session Complete!</h2>
                <p class="text-gray-500 text-sm mb-8">Here is how you performed</p>

                <div class="relative w-40 h-40 mx-auto mb-8 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" class="text-gray-100" />
                        <circle id="score-circle" cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" class="text-brand-500 transition-all duration-1000 ease-out" stroke-dasharray="440" stroke-dashoffset="440" stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="score-val" class="text-4xl font-extrabold text-gray-800">0%</span>
                    </div>
                </div>

                <p id="score-msg" class="text-lg font-medium text-gray-700 mb-8"></p>

                <button onclick="goSubmenu()" class="w-full bg-white border-2 border-gray-100 hover:border-brand-500 text-gray-700 hover:text-brand-600 font-bold py-3.5 rounded-xl transition-all">
                    Back to Topics
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://ilsmjyvpduvmkxoxcqin.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_7ZI3V6f0ckuxpASg3febTw_E_oxey_I";
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let appState = {
            data: [],
            currentCategory: null,
            currentSet: [],
            index: 0, score: 0,
            mode: 'study', isSignUp: false
        };

        // Modern Icons Mapping (Phosphor Icons)
        const ICONS = {
            "Pharmacology": "ph-pill", 
            "Anatomy": "ph-bone", 
            "Pediatrics": "ph-baby", 
            "Physiology": "ph-heartbeat", 
            "Nutrition": "ph-apple", 
            "General": "ph-books",
            "Cardiology": "ph-heart", 
            "Psychiatric": "ph-brain",
            "Default": "ph-folder"
        };

        window.onload = function() {
            const user = localStorage.getItem('quizUser');
            if(user) showApp(user);
        };

        // --- TOAST NOTIFICATIONS ---
        function showToast(msg, type = 'error') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const bg = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const icon = type === 'error' ? 'ph-warning-circle' : 'ph-check-circle';
            
            el.className = `${bg} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm font-semibold pointer-events-auto transform transition-all duration-300 translate-x-10 opacity-0`;
            el.innerHTML = `<i class="ph-bold ${icon} text-lg"></i> ${msg}`;
            
            container.appendChild(el);
            
            // Animation In
            requestAnimationFrame(() => { el.classList.remove('translate-x-10', 'opacity-0'); });

            // Remove after 3s
            setTimeout(() => {
                el.classList.add('translate-x-10', 'opacity-0');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- AUTH ---
        async function handleAuth() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = document.getElementById('auth-btn');
            
            if(!u || !p) return showToast("Please enter both fields.");

            const originalBtn = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span>';

            try {
                if(appState.isSignUp) {
                    const { data } = await _supabase.from('users').select('*').eq('username', u);
                    if(data.length > 0) throw new Error("Username taken");
                    
                    const { error } = await _supabase.from('users').insert({ username: u, password: p });
                    if(error) throw error;
                    showToast("Account created! Logging in...", "success");
                } else {
                    const { data } = await _supabase.from('users').select('*').eq('username', u).eq('password', p);
                    if(!data || data.length === 0) throw new Error("Invalid credentials");
                }
                
                localStorage.setItem('quizUser', u);
                showApp(u);
            } catch (e) {
                showToast(e.message || "Connection error");
                btn.disabled = false;
                btn.innerHTML = originalBtn;
            }
        }

        function toggleAuthMode() {
            appState.isSignUp = !appState.isSignUp;
            document.getElementById('auth-title').innerText = appState.isSignUp ? "Create Account" : "Welcome Back";
            document.getElementById('auth-btn').innerHTML = appState.isSignUp ? '<span>Sign Up</span> <i class="ph-bold ph-arrow-right"></i>' : '<span>Log In</span> <i class="ph-bold ph-arrow-right"></i>';
            document.getElementById('toggle-link').innerText = appState.isSignUp ? "Have an account? Log In" : "New here? Create an account";
        }

        function signOut() { 
            localStorage.removeItem('quizUser'); 
            location.reload(); 
        }

        // --- CORE NAVIGATION ---
        async function showApp(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
            
            try {
                const { data, error } = await _supabase.from('questions').select('*');
                if(error) throw error;
                
                appState.data = data || [];
                document.getElementById('display-user').innerText = user;
                document.getElementById('nav-user').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                goHome();
            } catch (e) {
                showToast("Failed to load data");
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        function hideAll() {
            ['dashboard-screen', 'submenu-screen', 'session-screen', 'result-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function goHome() {
            hideAll();
            document.getElementById('dashboard-screen').classList.remove('hidden');
            
            const categories = [...new Set(appState.data.map(q => q.category || 'General'))].sort();
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = "";

            categories.forEach((cat, idx) => {
                const iconClass = ICONS[cat] || ICONS["Default"];
                const count = appState.data.filter(q => (q.category || 'General') === cat).length;
                // Staggered animation delay
                const delay = idx * 50; 
                
                grid.innerHTML += `
                <div class="glass p-5 rounded-2xl cursor-pointer hover:-translate-y-1 hover:shadow-xl transition-all group animate-fade-in" 
                     style="animation-delay: ${delay}ms"
                     onclick="openCategory('${cat}')">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 text-white flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform">
                        <i class="ph-duotone ${iconClass} text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg">${cat}</h3>
                    <p class="text-xs font-semibold text-gray-400 mt-1">${count} Questions</p>
                </div>`;
            });
        }

        function openCategory(cat) {
            appState.currentCategory = cat;
            hideAll();
            document.getElementById('submenu-screen').classList.remove('hidden');
            document.getElementById('submenu-title').innerText = cat;

            const filtered = appState.data.filter(q => (q.category || 'General') === cat);
            const subjects = [...new Set(filtered.map(q => q.subject))].sort();
            
            const grid = document.getElementById('topics-grid');
            grid.innerHTML = "";

            subjects.forEach((sub, idx) => {
                const count = filtered.filter(q => q.subject === sub).length;
                const displayName = sub.replace(/Week \d+: |Module \d+: /i, "");
                
                grid.innerHTML += `
                <div class="glass p-4 rounded-xl cursor-pointer hover:bg-white hover:shadow-lg transition-all flex items-center justify-between group animate-slide-up"
                     style="animation-delay: ${idx * 50}ms"
                     onclick="startSession('${sub}')">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 text-brand-600 flex items-center justify-center">
                            <i class="ph-bold ph-file-text"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 group-hover:text-brand-600 transition-colors">${displayName}</h4>
                            <p class="text-xs text-gray-400">${count} Qs</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-300 group-hover:text-brand-500"></i>
                </div>`;
            });
        }

        function goSubmenu() {
            if(appState.currentCategory) openCategory(appState.currentCategory);
            else goHome();
        }

        function setMode(m) {
            appState.mode = m;
            const studyBtn = document.getElementById('tab-study');
            const testBtn = document.getElementById('tab-test');
            
            // Toggle classes for visual "Tab Switch" effect
            if (m === 'study') {
                studyBtn.className = "flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-white text-brand-600 shadow-md transform scale-100";
                testBtn.className = "flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 flex items-center justify-center gap-2 hover:text-gray-700 transition-all";
            } else {
                testBtn.className = "flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-white text-brand-600 shadow-md transform scale-100";
                studyBtn.className = "flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 flex items-center justify-center gap-2 hover:text-gray-700 transition-all";
            }
        }

        // --- GAME LOGIC ---
        function startSession(subject) {
            const pool = appState.data.filter(q => q.subject === subject);
            appState.currentSet = pool.sort(() => 0.5 - Math.random()).slice(0, 15);
            appState.index = 0; 
            appState.score = 0;
            
            hideAll();
            document.getElementById('session-screen').classList.remove('hidden');
            loadCard();
        }

        function loadCard() {
            const q = appState.currentSet[appState.index];
            const isStudy = appState.mode === 'study';
            
            // Update Progress
            const progressPct = ((appState.index) / appState.currentSet.length) * 100;
            document.getElementById('progress-bar').style.width = `${progressPct}%`;
            document.getElementById('session-progress').innerText = `${appState.index + 1} / ${appState.currentSet.length}`;
            
            // Text
            const qText = document.getElementById('q-text');
            qText.innerText = q.question;
            qText.classList.remove('animate-fade-in');
            void qText.offsetWidth; // Trigger reflow
            qText.classList.add('animate-fade-in');

            // Reset UI
            document.getElementById('rationale-area').classList.add('hidden');
            const btn = document.getElementById('action-btn');
            btn.classList.add('hidden');
            btn.innerHTML = isStudy ? '<span>Next Card</span> <i class="ph-bold ph-arrow-right"></i>' : '<span>Next Question</span> <i class="ph-bold ph-arrow-right"></i>';
            btn.onclick = nextCard;

            // Options
            const box = document.getElementById('options-area');
            box.innerHTML = "";
            
            let opts = [];
            try { opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options; } catch(e) { opts = ["Error loading options"]; }
            
            opts.forEach((opt, idx) => {
                const b = document.createElement('button');
                // Base styles
                b.className = "w-full text-left p-4 rounded-xl border-2 border-transparent bg-gray-50 hover:bg-gray-100 transition-all font-medium text-gray-700 relative overflow-hidden group animate-slide-up";
                b.style.animationDelay = `${idx * 100}ms`;
                b.innerHTML = `<span class="relative z-10 flex items-start gap-3"><div class="mt-1 w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-brand-400 flex items-center justify-center transition-colors"><div class="w-2.5 h-2.5 rounded-full bg-brand-500 opacity-0 transition-opacity"></div></div> <span class="flex-1 leading-relaxed">${opt}</span></span>`;
                
                b.onclick = () => {
                    if(b.parentElement.querySelector('.selected')) return; // Block multiple clicks
                    
                    // Mark Selected
                    document.querySelectorAll('#options-area button').forEach(x => {
                        x.classList.remove('selected', 'ring-2', 'ring-brand-500', 'bg-brand-50');
                        x.querySelector('.w-2\\.5').classList.add('opacity-0');
                    });
                    b.classList.add('selected', 'ring-2', 'ring-brand-500', 'bg-brand-50');
                    b.querySelector('.w-2\\.5').classList.remove('opacity-0');
                    
                    q.userSelected = opt;
                    if(isStudy) reveal(q, b);
                    else btn.classList.remove('hidden');
                };
                box.appendChild(b);
            });
        }

        function reveal(q, selectedBtn) {
            const btns = document.querySelectorAll('#options-area button');
            btns.forEach(b => {
                b.disabled = true;
                b.classList.add('cursor-default');
                const text = b.innerText.trim();
                
                // Logic for styling
                if (text === q.answer) {
                    b.className = "w-full text-left p-4 rounded-xl border-2 border-green-500 bg-green-50 text-green-800 font-bold transition-all relative overflow-hidden";
                    b.innerHTML = `<div class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-xl text-green-600"></i> ${text}</div>`;
                } else if (b === selectedBtn) {
                    b.className = "w-full text-left p-4 rounded-xl border-2 border-red-400 bg-red-50 text-red-800 transition-all opacity-100 animate-shake";
                    b.innerHTML = `<div class="flex items-center gap-3"><i class="ph-fill ph-x-circle text-xl text-red-500"></i> ${text}</div>`;
                } else {
                    b.classList.add('opacity-50');
                }
            });

            // Show Rationale
            document.getElementById('rationale-text').innerText = q.rationale || "No rationale available.";
            document.getElementById('rationale-area').classList.remove('hidden');
            document.getElementById('action-btn').classList.remove('hidden');
        }

        function nextCard() {
            const q = appState.currentSet[appState.index];
            if(appState.mode === 'test' && q.userSelected === q.answer) appState.score++;
            
            appState.index++;
            if(appState.index < appState.currentSet.length) loadCard();
            else showResults();
        }

        function showResults() {
            hideAll();
            document.getElementById('result-screen').classList.remove('hidden');
            
            const total = appState.currentSet.length;
            const pct = Math.round((appState.score / total) * 100);
            
            // Animated Circle Progress
            const circle = document.getElementById('score-circle');
            const circumference = 2 * Math.PI * 70; // r=70
            const offset = circumference - (pct / 100) * circumference;
            
            setTimeout(() => {
                circle.style.strokeDashoffset = offset;
                document.getElementById('score-val').innerText = `${pct}%`;
            }, 100);

            // Message & Confetti
            let msg = "";
            if(pct >= 80) {
                msg = "Outstanding! You're ready.";
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6', '#10b981', '#f59e0b'] });
            } else if(pct >= 60) {
                msg = "Good job. Review the weak spots.";
            } else {
                msg = "Keep studying, you'll get there!";
            }
            document.getElementById('score-msg').innerText = msg;
        }
    </script>
</body>
</html>
